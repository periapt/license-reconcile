#!/usr/bin/perl 
use strict;
use warnings;
use Getopt::Long;
use Pod::Usage;
use File::Slurp;
use Readonly;
use Debian::LicenseReconcile::Errors;
use Debian::LicenseReconcile::FormatSpec;

my $man = 0;
my $help = 0;
my $quiet = 0;

my $copyright = 'debian/copyright';

my $format_spec = 1;

GetOptions(
    'help|?' => \$help,
    man => \$man,
    'copyright=s' => \$copyright,
    'format-spec!' => \$format_spec,
    'quiet!' => \$quiet,
) or pod2usage(2);
pod2usage(1) if $help;
pod2usage(-exitstatus => 0, -verbose => 2) if $man;

Readonly my $COPYRIGHT_TEXT => scalar read_file($copyright);

if ($format_spec) {
        Debian::LicenseReconcile::FormatSpec->check($COPYRIGHT_TEXT);
}

my $copyright_target => Debian::LicenseReconcile::CopyrightTarget->new;
if ($copyright_target->parse($COPYRIGHT_TEXT)) {
}

if (not $quiet) {
    foreach my $error (Debian::LicenseReconcile::Errors->list) {
        print "$error->{test}: $error->{msg}\n";
    }
}

exit(Debian::LicenseReconcile::Errors->how_many);

=head1 NAME

license-reconcile - reconcile debian/copyright against source

=head1 SYNOPSIS

B<license-reconcile> B<--help>|B<--man>

B<license-reconcile> [B<--copyright=>I<file>] [B<--no-format-spec>] [B<--quiet>]

=head1 DESCRIPTION

B<license-reconcile> attempts to match license and copyright information
in a directory with the information available in C<debian/copyright>.
By default the tests run are as follows:

=over

=item - Does the copyright file have an approved format specification as its
first line?

=item - Can the copyright file be parsed?

=item - Does the copyright file have a C<Files: *> paragraph as a default case?

=item - Can every file, license and copyright datum extracted from the source be
contained in a matching paragraph from the copyright file?

=back

=head1 OPTIONS

=head2 B<--copyright=>I<file>

Specify an alternative copyright file. Defaults to C<debian/copyright>.

=head2 B<--no-format-spec>

Don't check the first line of the copyright file against permitted format
specifications.

=head2 B<--quiet>

Don't give any explanantions, simply a success or a fail via the exit status.
